{% extends 'page.html.twig' %}

{% macro draw_actions(rclass, member, login, plugin_actions) %}
                    <td class="{{ rclass }} center actions_row">
    {% if member.canEdit(login) %}
                        <a
                            href="{{ path_for("editMember", { "id": member.id }) }}"
                            class="tooltip action"
                        >
                            <i class="ui user edit icon" aria-hidden="true"></i>
                            <span class="sr-only">{{ _T("%membername: edit information")|replace({ "%membername": member.sname }) }}</span>
                        </a>
    {% endif %}
    {% if login.isAdmin() or login.isStaff() %}
                        <a
                            href="{{ path_for("contributions", { "type": "contributions", "option": "member", "value": member.id }) }}"
                            class="tooltip"
                        >
                            <i class="ui cookie green icon" aria-hidden="true"></i>
                            <span class="sr-only">{{ _T("%membername: contributions")|replace({ "%membername": member.sname }) }}</span>
                        </a>
                        <a
                            href="{{ path_for("removeMember",  { "id": member.id }) }}"
                            class="delete tooltip"
                        >
                            <i class="ui user times red icon" aria-hidden="true"></i>
                            <span class="sr-only">{{ _T("%membername: remove from database")|replace({ "%membername": member.sname }) }}</span>
                        </a>
    {% endif %}
    {% if login.isSuperAdmin() %}
                        <a
                            href="{{ path_for("impersonate", { "id": member.id }) }}"
                            class="tooltip"
                        >
                            <i class="ui user secret grey icon" aria-hidden="true"></i>
                            <span class="sr-only">{{ _T("Log in in as %membername")|replace({ "%membername": member.sname }) }}</span>
                        </a>
    {% endif %}
    {# If some additionnals actions should be added from plugins, we load the relevant template file
    We have to use a template file, so Smarty will do its work (like replacing variables). #}
    {% if plugin_actions|length != 0 %}
        {% for plugin_name, action in plugin_actions %}
            {% include action with { module_id: plugin_name|replace({'actions_': ''}) } %}
        {% endfor %}
    {% endif %}
                    </td>
{% endmacro %}

{% block content %}
        <form action="{{ path_for('filter-memberslist') }}" method="post" id="filtre" class="ui form">
            <div class="ui segment">
{% if adv_filters is not defined or not adv_filters %}
            <div class="five fields">
                <div class="field">
                    <label for="filter_str">{{ _T('Search:') }}</label>
                    <input type="text" name="filter_str" id="filter_str" value="{{ filters.filter_str }}" type="search" placeholder="{{ _T('Enter a value') }}"/>
                </div>
                <div class="field">
                    <label for="field_filter">{{ _T('in:') }}</label>
                    <select name="field_filter" id="field_filter" class="ui search dropdown nochosen">
    {% for key, value in field_filter_options %}
                        <option value="{{ key }}"{% if key == filters.field_filter %} selected="selected"{% endif %}>{{ value }}</option>
    {% endfor %}
                    </select>
                </div>
                <div class="field">
                    <label for="filter_str">{{ _T('among:') }}</label>
                    <select name="membership_filter" onchange="form.submit()" class="ui search dropdown nochosen">
                        {% for key, value in membership_filter_options %}
                            <option value="{{ key }}"{% if key == filters.membership_filter %} selected="selected"{% endif %}>{{ value }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="flexend field">
                    <label for="filter_account" class="hidden">{{ _T('among:') }}</label>
                    <select name="filter_account" onchange="form.submit()" class="ui search dropdown nochosen">
                        {% for key, value in filter_accounts_options %}
                            <option value="{{ key }}"{% if key == filters.filter_account %} selected="selected"{% endif %}>{{ value }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="flexend field">
                    <label for="group_filter" class="hidden">{{ _T('among:') }}</label>
                    <select name="group_filter" onchange="form.submit()" class="ui search dropdown nochosen">
                        <option value="0">{{ _T('Select a group') }}</option>
    {% for group in filter_groups_options %}
                        <option value="{{ group.getId() }}"{% if filters.group_filter == group.getId() %} selected="selected"{% endif %}>{{ group.getIndentName()|raw }}</option>
    {% endfor %}
                    </select>
                </div>
            </div>
            <div class="two fields">
                <div class="field">
                    <div class="inline fields">
                        <label for="email_filter">{{ _T('Members that have an email address:') }}</label>
                        <div class="field inline">
                            <div class="ui radio checkbox">
                                <input type="radio" name="email_filter" id="filter_dc_email" value="{{ constant('Galette\\Repository\\Members::FILTER_DC_EMAIL') }}"{% if filters.email_filter == constant('Galette\\Repository\\Members::FILTER_DC_EMAIL') %} checked="checked"{% endif %}>
                                <label for="filter_dc_email">{{ _T("Don't care") }}</label>
                            </div>
                        </div>
                        <div class="field inline">
                            <div class="ui radio checkbox">
                                <input type="radio" name="email_filter" id="filter_with_email" value="{{ constant('Galette\\Repository\\Members::FILTER_W_EMAIL') }}"{% if filters.email_filter == constant('Galette\\Repository\\Members::FILTER_W_EMAIL') %} checked="checked"{% endif %}>
                                <label for="filter_with_email">{{ _T('With') }}</label>
                            </div>
                        </div>
                        <div class="field inline">
                            <div class="ui radio checkbox">
                                <input type="radio" name="email_filter" id="filter_without_email" value="{{ constant('Galette\\Repository\\Members::FILTER_WO_EMAIL') }}"{% if filters.email_filter == constant('Galette\\Repository\\Members::FILTER_WO_EMAIL') %} checked="checked"{% endif %}>
                                <label for="filter_without_email">{{ _T('Without') }}</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="right aligned field">
                    <button type="submit"  class="tooltip action ui primary button" title="{{ _T('Apply filters') }}" name="filter">
                        <i class="search icon"></i>
                        {{ _T('Filter') }}
                    </button>
                    <button type="submit"  class="tooltip action ui button" title="{{ _T('Save selected criteria') }}" name="savesearch" id="savesearch">
                        <i class="save blue icon"></i>
                        {{ _T('Save') }}
                    </button>
                    <input type="submit" name="clear_filter" class="tooltip ui button" value="{{ _T('Clear filter') }}" title="{{ _T('Reset all filters to defaults') }}"/>
                </div>
            </div>
{% else %}
            <div class="field">
                <span class="ui primary ribbon label">{{ _T('Advanced search mode') }}</span>
                <button type="submit"  class="tooltip action ui primary button" title="{{ _T('Save current advanced search criteria') }}" name="savesearch" id="savesearch">
                    <i class="save icon"></i>
                    {{ _T('Save') }}
                </button>
                <button type="submit" class="tooltip action ui button" title="{{ _T('Change search criteria') }}" name="adv_criteria">
                    <i class="edit blue icon"></i>
                    {{ _T('Change criteria') }}
                </button>
                <input type="hidden" name="advanced_search" value="1" class="ui button"/>
                <input type="submit" name="clear_filter" class="tooltip ui button" value="{{ _T('Clear filter') }}" title="{{ _T('Reset all filters to defaults') }}"/>
                <div class="ui basic fluid accordion">
                    <div class="title">
                        <i class="dropdown icon"></i>
                        {{ _T('Show/hide query') }}
                    </div>
                    <div class="content">
                        <pre id="sql_qry" class="hidden">{{ filters.query }}</pre>
                    </div>
                </div>
            </div>
{% endif %}
            {% include "components/forms/csrf.html.twig" %}
        </div>

        <div class="infoline">
            <div class="ui basic horizontal segments">
                <div class="ui basic fitted segment">
                    <div class="ui label">{{ _Tn("%count member", "%count members", nb_members)|replace({ '%count': nb_members }) }}</div>
                </div>
                <div class="ui basic right aligned fitted segment">
                    <div class="inline field">
                        <label for="nbshow">{{ _T('Records per page:') }}</label>
                        <select name="nbshow" id="nbshow" class="ui dropdown nochosen">
                            {% for key, value in nbshow_options %}
                                <option value="{{ key }}"{% if key == numrows %} selected="selected"{% endif %}>{{ value }}</option>
                            {% endfor %}
                        </select>
                        <noscript> <span><input type="submit" value="{{ _T('Change') }}" /></span></noscript>
                    </div>
                </div>
            </div>
        </div>
        </form>
        <form action="{{ path_for('batch-memberslist') }}" method="post" id="listform" class="ui form">
        <div class="ui basic fitted segment">
            <table class="listing ui celled table">
                <thead>
                    <tr>
{% for column in galette_list %}
    {% if column.field_id == 'id_adh' %}
        {% if preferences.pref_show_id %}
                        <th class="id_row">
                            <a href="{{ path_for("members", { "option": "order", "value": constant("Galette\\Repository\\Members::ORDERBY_ID") }) }}">
                            {{ _T('Mbr id') }}
                            {% if filters.orderby == constant('Galette\\Repository\\Members::ORDERBY_ID') %}
                                {% if filters.ordered == constant('Galette\Filters\MembersList::ORDER_ASC') %}
                                <i class="ui angle down icon tooltip"></i>
                                {% else %}
                                <i class="ui angle up icon tooltip"></i>
                                {% endif %}
                            {% endif %}
                            </a>
                        </th>
        {% else %}
                        <th class="id_row">#</th>
        {% endif %}
    {% else %}
                        <th class="left">
                            <a href="{{ path_for("members", {"option": "order", "value": column.field_id}) }}">
                            {{ column.label }}
                            {% if filters.orderby == column.field_id %}
                                {% if filters.ordered == constant('Galette\Filters\MembersList::ORDER_ASC') %}
                                <i class="ui angle down icon tooltip"></i>
                                {% else %}
                                <i class="ui angle up icon tooltip"></i>
                                {% endif %}
                            {% endif %}
                            </a>
                        </th>
    {% endif %}
{% endfor %}
                        <th class="actions_row">{{ _T('Actions') }}</th>
                    </tr>
                </thead>
                <tbody>
{% for ordre, member in members %}
    {% set rclass = member.getRowClass() %}
                    <tr>
    {% for column in galette_list %}
        {% if column.field_id == 'id_adh' %}
                        <td class="{{ rclass }} right" data-scope="id">
            {% if preferences.pref_show_id %}
                        {{ member.id }}
            {% else %}
                        {{ ordre + 1 + (filters.current_page - 1) * numrows }}
            {% endif %}
                        </td>
        {% elseif column.field_id == 'list_adh_name' %}
                        <td class="{{ rclass }} username_row" data-scope="row">
                            <input type="checkbox" name="member_sel[]" value="{{ member.__get('id') }}"/>
            {% if member.isCompany() %}
                            <i class="ui building outline icon tooltip"><span class="sr-only">{{ _T('Is a company') }}</span></i>
            {%  elseif member.isMan() %}
                            <i class="ui male icon tooltip"><span class="sr-only">{{ _T('Is a man') }}</span></i>
            {%  elseif member.isWoman() %}
                            <i class="ui female icon tooltip"><span class="sr-only">{{ _T('Is a woman') }}</span></i>
            {% else %}
                            <i class="ui icon"></i>
            {% endif %}
            {% if member.email != '' %}
                            <a href="mailto:{{ member.email }}" class="tooltip">
                                <i class="ui envelope outline teal icon" aria-hidden="true"></i>
                                <span class="sr-only">{{ _T('Mail') }}</span>
                            </a>
            {% else %}
                            <i class="ui icon"></i>
            {% endif %}
            {% if member.isAdmin() %}
                            <span class="tooltip">
                                <i class="ui user shield red icon" aria-hidden="true"></i>
                                <span class="sr-only">{{ _T('Admin') }}</span>
                            </span>
            {% elseif member.isStaff() %}
                            <span class="tooltip">
                                <i class="ui id card alternate orange icon" aria-hidden="true"></i>
                                <span class="sr-only">{{ _T('Staff member') }}</span>
                            </span>
                {# TODO: display for group managers #}
            {% else %}
                            <i class="ui icon"></i>
            {% endif %}
                        {% set mid = member.id %}
                            <a href="{{ path_for("member", {"id": member.id}) }}">{{ member.sname }}{% if member.company_name %} ({{ member.company_name }}){% endif %}</a>
                        </td>
        {% else %}
            {% set lrclass = rclass %}
            {% set propname = column.propname %}
            {% set propvalue =  attribute(member, propname) %}
            {% set value = null %}

            {% if column.field_id == 'nom_adh' %}
                {% set value = member.sfullname %}
            {% elseif column.field_id == 'pseudo_adh' %}
                {% set lrclass = rclass %}
                {% set value = attribute(member, propname) %}
            {% elseif column.field_id == 'tel_adh' or column.field_id == 'gsm_adh' %}
                {% set lrclass = rclass %}
            {% elseif column.field_id == 'id_statut' %}
                {% set lrclass = rclass %}
                {% set value = member.sstatus %}
            {% elseif column.field_id == 'titre_adh' %}
                {% if member.title is iterable %}
                    {% set value = member.title.long %}
                {% endif %}
            {% elseif column.field_id == 'pref_lang' %}
                {% set value = i18n.getNameFromId(member.language) %}
            {% elseif column.field_id == 'adresse_adh' %}
                {% set value = member.saddress|e('html')|nl2br %}
                {% set escaped = true %}
            {% elseif column.field_id == 'bool_display_info' %}
                {% set value = member.sappears_in_list %}
            {% elseif column.field_id == 'activite_adh' %}
                {% set value = member.sactive %}
            {% elseif column.field_id == 'id_statut' %}
                {% set value = member.sstatus %}
            {% elseif column.field_id == 'bool_admin_adh' %}
                {% set value = member.sadmin %}
            {% elseif column.field_id == 'bool_exempt_adh' %}
                {% set value = member.sdue_free %}
            {% elseif column.field_id == 'sexe_adh' %}
                {% set value = member.sgender %}
            {% endif %}

            {# If value has not been set, take the generic value #}
            {% if not value %}
                {% if propvalue %}
                    {% set value = propvalue|e('html') %}
                {% else %}
                    {% set value = propvalue %}
                {% endif %}
            {% elseif escaped is not defined %}
                {% set value = value|e('html') %}
            {% endif %}

                        <td class="{{ lrclass }}" data-title="{{ column.label }}">
            {# Display column.
                A check is done here to adapt display, this is may not the best way to go
                but for now, that works as expected.
            #}
            {% if value %}
                {% if column.field_id == 'email_adh' %}
                                <a href="mailto:{{ value }}">{{ value }}</a>
                {% elseif column.field_id == 'tel_adh' or column.field_id == 'gsm_adh' %}
                                <a href="tel:{{ value }}">{{ value }}</a>
                {% elseif column.field_id == 'parent_id' %}
                                <a href="{{ path_for("member", {"id": member.parent}) }}">{{ memberName(member.parent) }}</a>
                {% elseif column.field_id == 'ddn_adh' %}
                                {{ value }} {{ member.getAge() }}
                {% else %}
                                {{ value }}
                {% endif %}
            {% endif %}
                        </td>
        {% endif %}
    {% endfor %}
                    {{ _self.draw_actions(rclass, member, login, plugin_actions) }}
                    </tr>
{% else %}
                    <tr><td colspan="{{ galette_list|length }}" class="emptylist">{{ _T('No member has been found') }}</td></tr>
{% endfor %}
                </tbody>
            </table>
        </div>
{% if nb_members != 0 and (login.isGroupManager() and preferences.pref_bool_groupsmanagers_exports or login.isAdmin() or login.isStaff()) %}
        <div class="ui bottom attached segment screen-only">
            <div class="ui horizontal list">
                <span class="ui primary ribbon label">{{ _T('For the selection:') }}</span>
    {% if login.isAdmin() or login.isStaff() %}
                <div class="item">
                    <button type="submit" id="masschange" name="masschange" class="action ui labeled icon tiny button">
                        <i class="user edit blue icon"></i> {{ _T('Mass change') }}
                    </button>
                </div>
                <div class="item">
                    <button type="submit" id="masscontributions" name="masscontributions" class="action ui labeled icon tiny button">
                        <i class="ui cookie bite green icon"></i> {{ _T('Mass add contributions') }}
                    </button>
                </div>
                <div class="item">
                    <button type="submit" id="delete" name="delete" class="ui labeled icon tiny button">
                        <i class="user times red icon"></i> {{ _T('Delete') }}
                    </button>
                </div>
    {% endif %}
    {% if login.isAdmin() or login.isStaff() or login.isGroupManager() and preferences.pref_bool_groupsmanagers_mailings %}
        {% if preferences.pref_mail_method != constant('Galette\\Core\\GaletteMail::METHOD_DISABLED') %}
                <div class="item">
                    <button type="submit" id="sendmail" name="mailing" class="ui labeled icon tiny button">
                        <i class="mail bulk icon"></i> {{ _T('Mail') }}
                    </button>
                </div>
        {% endif %}
    {% endif %}

    {% if login.isGroupManager() and preferences.pref_bool_groupsmanagers_exports or login.isAdmin() or login.isStaff() %}
                <div class="item">
                    <button type="submit" id="attendance_sheet" name="attendance_sheet" class="ui labeled icon tiny button">
                        <i class="file alternate icon"></i> {{ _T('Attendance sheet') }}
                    </button>
                </div>
                <div class="item">
                    <button type="submit" id="labels" name="labels" class="ui labeled icon tiny button">
                        <i class="address card icon"></i> {{ _T('Generate labels') }}
                    </button>
                </div>
                <div class="item">
                    <button type="submit" id="cards" name="cards" class="ui labeled icon tiny button">
                        <i class="id badge icon"></i> {{ _T('Generate Member Cards') }}
                    </button>
                </div>
                <div class="item">
                    <button type="submit" id="csv" name="csv" class="ui labeled icon tiny button">
                        <i class="file csv icon"></i> {{ _T('Export as CSV') }}
                    </button>
                </div>
    {% endif %}
    {% if plugin_batch_actions|length != 0 %}
        {% for plugin_name, action in plugin_batch_actions %}
            {% include action with { module_id: plugin_name|replace({ 'batch_action_': '' }) } %}
        {% endfor %}
    {% endif %}
            </div>
        </div>
        <div class="ui basic center aligned fitted segment">
            <div class="ui inverted pagination menu">
                <div class="header item">
                    {{ _T('Pages:') }}
                </div>
                {{ pagination|raw }}
            </div>
        </div>
{% endif %}
            {% include "components/forms/csrf.html.twig" %}
        </form>
    {% if nb_members != 0 %}
        <div id="legende" title="{{ _T('Legend') }}" class="ui modal">
            <div class="header">{{ _T('Legend') }}</div>
            <div class="content">
                <table class="ui stripped table">
                    <thead>
                        <tr>
                            <th class="" colspan="4">{{ _T('Reading the list') }}</th>
                        </tr>
                    <thead>
                    <tbody>
                        <tr>
                            <th class="back">{{ _T('Name') }}</th>
                            <td class="back">{{ _T('Active account') }}</td>
                            <th class="inactif back">{{ _T('Name') }}</th>
                            <td class="back">{{ _T('Inactive account') }}</td>
                        </tr>
                        <tr>
                            <th class="cotis-ok color-sample">&nbsp;</th>
                            <td class="back">{{ _T('Membership in order') }}</td>
                            <th class="cotis-soon color-sample">&nbsp;</th>
                            <td class="back">{{ _T('Membership will expire soon (&lt;30d)') }}</td>
                        </tr>
                        <tr>
                            <th class="cotis-never color-sample">&nbsp;</th>
                            <td class="back">{{ _T('Never contributed') }}</td>
                            <th class="cotis-late color-sample">&nbsp;</th>
                            <td class="back">{{ _T('Lateness in fee') }}</td>
                        </tr>
                    </tbody>
                </table>
                <table class="ui stripped table">
                    <thead>
                        <tr>
                            <th class="" colspan="4">{{ _T('Actions') }}</th>
                        </tr>
                    <thead>
                    <tbody>
                        <tr>
                            <th class="action">
                                <i class="ui user edit icon"></i>
                            </th>
                            <td class="back">{{ _T('Modification') }}</td>
                            <th>
                                <i class="ui cookie icon"></i>
                            </th>
                            <td class="back">{{ _T('Contributions') }}</td>
                        </tr>
                        <tr>
                            <th class="delete">
                                <i class="ui user times red icon"></i>
                            </th>
                            <td class="back">{{ _T('Deletion') }}</td>
                        </tr>
                    </tbody>
                </table>
                <table class="ui stripped table">
                    <thead>
                        <tr>
                            <th colspan="4">{{ _T('User status/interactions') }}</th>
                        </tr>
                    <thead>
                    <tbody>
                        <tr>
                            <th><i class="ui envelope outline teal icon"></i></th>
                            <td class="back">{{ _T('Send an email') }}</td>
                            <th><i class="ui building icon"></i></th>
                            <td class="back">{{ _T('Is a company') }}</td>
                        </tr>

                        <tr>
                            <th><i class="ui male icon"></i></th>
                            <td class="back">{{ _T('Is a man') }}</td>
                            <th><i class="ui female icon"></i></th>
                            <td class="back">{{ _T('Is a woman') }}</td>
                        </tr>
                        <tr>
                            <th><i class="ui user shield red icon"></i></th>
                            <td class="back">{{ _T('Admin') }}</td>
                            <th><i class="ui id card alternate orange icon"></i></th>
                            <td class="back">{{ _T('Staff member') }}</td>

                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="actions"><div class="ui labeled icon deny button"><i class="times icon"></i> {{ _T('Close') }}</div></div>
        </div>
    {% endif %}
{% endblock %}

{% block javascripts %}
        <script type="text/javascript">
{% if nb_members != 0 %}
        var _checkselection = function() {
            var _checkeds = $('table.listing').find('input[type=checkbox]:checked').length;
            if ( _checkeds == 0 ) {
                $('body').modal({
                    title: '{{ _T("No member selected")|e("js") }}',
                    class: 'tiny',
                    content: '{{ _T("Please make sure to select at least one member from the list to perform this action.")|e("js") }}',
                    actions: [{
                        text    : '{{ _T("Close")|e("js") }}',
                        class   : 'cancel'
                    }]
                }).modal('show');
                return false;
            }
            return true;
        }
{% endif %}
        {# Use of Javascript to draw specific elements that are not relevant is JS is inactive #}
        $(function(){
{% if nb_members != 0 %}
            var _checklinks = '<div class="checkboxes ui basic horizontal segments"><div class="ui basic fitted segment"><a href="#" class="checkall ui blue tertiary button">{{ _T("(Un)Check all")|e('js') }}</a> | <a href="#" class="checkinvert ui blue tertiary button">{{ _T("Invert selection")|e('js') }}</a></div><div class="ui basic right aligned fitted segment"><a href="#" class="show_legend ui blue tertiary button">{{ _T("Show legend")|e('js') }}</a></div></div>';
            $('.listing').before(_checklinks);
            $('.listing').after(_checklinks);
            _bind_check();
            _bind_legend();

            $('.selection_menu *[type="submit"], .selection_menu *[type="button"]').click(function(event){
                if ( this.id == 'delete' || this.id == 'masschange' ) {
                    //mass removal is handled from 2 steps removal
                    //mass change is specifically handled below
                    return;
                }

                if (!_checkselection()) {
                    return false;
                } else {
    {% if existing_mailing == true %}
                    if (this.id == 'sendmail') {
                        $('body').modal({
                            title: '{{ _T("Existing mailing")|e('js') }}',
                            class: 'tiny',
                            content: '{{ _T("A mailing already exists. Do you want to create a new one or resume the existing?")|e('js') }}',
                            actions: [{
                                text    : '{{ _T("Resume")|e('js') }}',
                                class   : 'blue cancel',
                                click   : function() {
                                    location.href = '{{ path_for('mailing') }}';
                                }
                            }, {
                                text    : '{{ _T("New")|e('js') }}',
                                class   : 'green approve',
                                click   : function() {
                                    //add required controls to the form, change its action URI, and send it.
                                    var _form = $('#listform');
                                    _form.append($('<input type="hidden" name="mailing_new" value="true"/>'));
                                    _form.append($('<input type="hidden" name="mailing" value="true"/>'));
                                    _form.submit();
                                }
                            }]
                        }).modal('show');
                        return false;
                    }
    {% endif %}
                    if (this.id == 'attendance_sheet') {
                        _attendance_sheet_details();
                        return false;
                    }

                    if (this.id == 'masscontributions') {
                        event.preventDefault();
                        $.ajax({
                            url: '{{ path_for('batch-memberslist') }}',
                            type: "POST",
                            data: {
                                ajax: true,
                                masscontributions: true,
                                member_sel: $('#listform input[type=\"checkbox\"]:checked').map(function(){
                                    return $(this).val();
                                }).get()
                            },
                            datatype: 'json',
                            {% include "elements/js/loader.js.twig" %},
                            success: function(res){
                                var _res = $(res);
                                _bindmassres(_res);
                                $('body').append(_res);

                                _massCheckboxes('#mass_contributions');

                                $('#mass_contributions').modal({
                                    actions: [{
                                        text    : '{{ _T("Close")|e('js') }}',
                                        class   : 'cancel'
                                    }]
                                }).modal('show');
                            },
                            error: function() {
                                alert("{{ _T("An error occurred :(")|e('js') }}");
                            }
                        });
                    }

                    return true;
                }
            });
{% endif %}
            if ( _shq = $('#showhideqry') ) {
                _shq.click(function(){
                    $('#sql_qry').toggleClass('hidden');
                    return false;
                });
            }

            $('#savesearch').on('click', function(e) {
                e.preventDefault();

                $('body').modal({
                    title: '{{ _T("Search title")|e('js') }}',
                    class: 'tiny',
                    content: '<div class="ui input"><input type="text" name="search_title" id="search_title"/></div>',
                    actions: [{
                        text    : '{{ _T("Save")|e('js') }}',
                        class   : 'green approve',
                        click   : function() {
                            var _form = $('#filtre');
                            var _data = _form.serialize();
                            _data = _data + "&search_title=" + $('#search_title').val();
                            $.ajax({
                                url: '{{ path_for('saveSearch') }}',
                                type: "POST",
                                data: _data,
                                datatype: 'json',
                                {% include "elements/js/loader.js.twig" %},
                                success: function(res) {
                                    $.ajax({
                                        url: '{{ path_for('ajaxMessages') }}',
                                        method: "GET",
                                        success: function (message) {
                                            $('#asso_name').after(message);
                                        }
                                    });
                                }
                            });
                        }
                    }, {
                        text    : '{{ _T("Cancel")|e('js') }}',
                        class   : 'cancel'
                    }]
                }).modal('show');
            });

        });
{% if nb_members != 0 %}
        var _bindmassres = function(res) {
            res.find('#btncancel')
                .button()
                .on('click', function(e) {
                    e.preventDefault();
                    res.modal('hide');
                });

            res.find('input[type=submit]')
                .button();

            res.find('select:not(.nochosen)').selectize({
                maxItems: 1
            });
        }

        $('#masschange').off('click').on('click', function(event) {
            event.preventDefault();
            var _this = $(this);

            if (!_checkselection()) {
                return false;
            }
            $.ajax({
                url: '{{ path_for('batch-memberslist') }}',
                type: "POST",
                data: {
                    ajax: true,
                    masschange: true,
                    member_sel: $('#listform input[type=\"checkbox\"]:checked').map(function(){
                        return $(this).val();
                    }).get()
                },
                datatype: 'json',
                {% include "elements/js/loader.js.twig" %},
                success: function(res){
                    var _res = $(res);
                    _bindmassres(_res);

                    _res.find('form').on('submit', function(e) {
                        e.preventDefault();
                        var _form = $(this);
                        var _data = _form.serialize();
                        $.ajax({
                            url: _form.attr('action'),
                            type: "POST",
                            data: _data,
                            datatype: 'json',
                            {% include "elements/js/loader.js.twig" %},
                            success: function(html) {
                                var _html = $(html);
                                _bindmassres(_html);

                                $('#mass_change').remove();
                                $('body').append(_html);

                                //_initTooltips('#mass_change');
                                //_massCheckboxes('#mass_change');

                                $('#mass_change').modal({
                                    actions: [{
                                        text    : '{{ _T("Close")|e('js') }}',
                                        class   : 'cancel'
                                    }]
                                }).modal('show');

                                _html.find('form').on('submit', function(e) {
                                    e.preventDefault();
                                    var _form = $(this);
                                    var _data = _form.serialize();
                                    $.ajax({
                                        url: _form.attr('action'),
                                        type: "POST",
                                        data: _data,
                                        datatype: 'json',
                                        {% include "elements/js/loader.js.twig" %},
                                        success: function(res) {
                                            if (res.success) {
                                                window.location.href = _form.find('input[name=redirect_uri]').val();
                                            } else {
                                                $.ajax({
                                                    url: '{{ path_for('ajaxMessages') }}',
                                                    method: "GET",
                                                    success: function (message) {
                                                        $('#asso_name').after(message);
                                                    }
                                                });
                                            }
                                        }
                                    });
                                });
                            },
                            error: function() {
                                alert("{{ _T("An error occurred :(")|e('js') }}");
                            }
                        });
                    });

                    $('body').append(_res);

                    _massCheckboxes('#mass_change');

                    $('#mass_change').modal({
                        actions: [{
                            text    : '{{ _T("Close")|e('js') }}',
                            class   : 'cancel'
                        }]
                    }).modal('show');
                },
                error: function() {
                    alert("{{ _T("An error occurred :(")|e('js') }}");
                }
            });
        });

        var _attendance_sheet_details = function(){
            var _selecteds = [];
            $('table.listing').find('input[type=checkbox]:checked').each(function(){
                _selecteds.push($(this).val());
            });
            $.ajax({
                url: '{{ path_for('attendance_sheet_details') }}',
                type: "POST",
                data: {
                    ajax: true,
                    selection: _selecteds
                },
                dataType: 'html',
                success: function(res){
                    $('body').modal({
                        title: '{{ _T("Attendance sheet details")|e("js") }}',
                        class: 'tiny',
                        content: res,
                        actions: [{
                            text    : '{{ _T("Continue")|e("js") }}',
                            class   : 'cancel',
                            click   : function() {
                                $('#sheet_details_form').submit();
                            }
                        }, {
                            text    : '{{ _T("Cancel")|e("js") }}',
                            class   : 'cancel'
                        }]
                    }).modal('show');
                },
                error: function() {
                    alert("{{ _T("An error occurred displaying attendance sheet details interface :(")|e('js') }}");
                }
            });
        }

        {% include "elements/js/removal.js.twig" %}
        {% include "elements/js/removal.js.twig" with { selector: "#delete", deleteurl: path_for("batch-memberslist"), extra_check: "if (!_checkselection()) { return false; }", extra_data: "delete: true, member_sel: $('#listform input[type=\"checkbox\"]:checked').map(function(){ return $(this).val(); }).get()", method: "POST" } %}
{% endif %}
    </script>
{% endblock %}
